<!doctype html> 
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Slots NeÃ³n PÃºrpura â€” 5 Tiros</title>
<style>
  :root{
    --bgDark:#0a0718; --bgDeep:#090a16; --ink:#eef4ff; --muted:#a9b7d8;
    --tubeA:#8a5dff; --tubeB:#ff4de1; --tubeC:#56d0ff;
    --panel1:#171a3f; --panel2:#0c1230;
    --bezel1:#ffe39a; --bezel2:#ffc54d; --bezel3:#d48a07; --bezel4:#7a4e05;
    --accent:#c06bff; --accent2:#ffd86a; --bulb:rgba(255,235,160,1); --bulbGlow:rgba(255,200,90,.9);
    --green:#8EFF98;
  }
  *{box-sizing:border-box} html,body{height:100%}

  body{
    margin:0; color:var(--ink);
    background:
      linear-gradient(rgba(18,8,38,.10), rgba(8,7,20,.50)),
      url("https://ricomx.ft-crm.com/media-api/serve/d9ac58ea-8cb5-4568-9bf6-01928a0e087a_BG1.jpg") center/cover no-repeat fixed;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    display:flex; align-items:center; justify-content:center;
    padding:clamp(10px,4vw,18px);
    -webkit-text-size-adjust:100%;
  }
  @supports (-webkit-touch-callout:none){ body{ background-attachment:scroll } }

  .backBtn{
    position:fixed; top:calc(10px + env(safe-area-inset-top)); left:calc(10px + env(safe-area-inset-left));
    z-index:99999;
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:12px; text-decoration:none;
    font-weight:900; letter-spacing:.3px; color:#0c1220; background:#eaf2ff;
    box-shadow:0 6px 24px rgba(0,0,0,.35), inset 0 -2px 0 rgba(0,0,0,.25);
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .backBtn:active{ transform:translateY(1px) }
  .backBtn svg{ width:16px; height:16px }

  .cabWrap{ position: relative; width: min(640px,96vw); }
  .cabWrap::before{
    content:"";
    position:absolute; inset:-8% -10% -14% -10%;
    z-index:-2; pointer-events:none;
    background:
      radial-gradient(closest-side at 50% 15%, rgba(113,225,255,.35), rgba(113,225,255,0) 70%),
      radial-gradient(closest-side at 60% 50%, rgba(192,107,255,.25), rgba(192,107,255,0) 72%),
      radial-gradient(closest-side at 40% 85%, rgba(255,216,106,.18), rgba(255,216,106,0) 70%);
    filter: blur(18px);
    opacity:.9;
    transform: translateZ(0);
  }
  .cabWrap::after{
    content:"";
    position:absolute; inset:-6% -8% -12% -8%;
    z-index:-2; pointer-events:none;
    background: radial-gradient(120% 100% at var(--sx,40%) var(--sy,10%),
                rgba(255,255,255,.16), rgba(255,255,255,0) 60%);
    filter: blur(10px);
    mix-blend-mode:screen;
    animation: sweep 7.5s ease-in-out infinite;
  }
  @keyframes sweep{
    0%   { --sx:35%; --sy:12%; opacity:.5; }
    50%  { --sx:65%; --sy:18%; opacity:.9; }
    100% { --sx:35%; --sy:12%; opacity:.5; }
  }
  .cabWrap .groundShadow{
    position:absolute; left:50%; bottom:-20px;
    width:78%; height:44px; transform:translateX(-50%);
    z-index:-1; pointer-events:none;
    background: radial-gradient(50% 100% at 50% 50%,
                rgba(0,0,0,.55) 0%, rgba(0,0,0,.22) 55%, rgba(0,0,0,0) 100%);
    filter: blur(6px);
  }

  .cab{
    position:relative; overflow:hidden; width:100%;
    border-radius:clamp(18px,3vw,30px);
    padding:clamp(14px,2.8vw,24px) clamp(12px,2.5vw,22px) clamp(10px,2.2vw,18px);
    background:linear-gradient(180deg,#151733,#0c0f25);
    box-shadow:
      0 40px 90px rgba(0,0,0,.65),
      inset 0 2px 0 rgba(255,255,255,.07),
      0 0 60px rgba(113,225,255,.18),
      0 0 80px rgba(192,107,255,.16);
  }
  .tubes,.tubes:before,.tubes:after{content:""; position:absolute; inset:10px; border-radius:28px; pointer-events:none}
  .tubes{border:10px solid transparent}
  .tubes:before{inset:-10px; border:10px solid var(--tubeA); filter:blur(10px); opacity:.9; animation:tubeCycle 6s linear infinite}
  .tubes:after {inset:-22px; border:14px solid var(--tubeB); filter:blur(18px); opacity:.45; animation:tubeCycle 6s linear reverse infinite}
  @keyframes tubeCycle{0%{border-color:var(--tubeA)}33%{border-color:var(--tubeB)}66%{border-color:var(--tubeC)}100%{border-color:var(--tubeA)}}

  .marquee{position:absolute; left:18px; right:18px; top:18px; height:20px; display:flex; gap:10px; justify-content:center; z-index:3}
  .bulb{width:12px;height:12px;border-radius:50%; background:radial-gradient(circle at 40% 35%,#fff,var(--bulb) 55%,rgba(255,255,180,.2) 100%);
        box-shadow:0 0 8px var(--bulbGlow),0 0 22px var(--bulbGlow); opacity:.3; animation:chase 1.1s linear infinite}
  .bulb:nth-child(odd){animation-delay:.2s} .bulb:nth-child(3n){animation-delay:.45s}
  @keyframes chase{0%{opacity:.25}12%{opacity:1}24%,100%{opacity:.25}}

  .brand{text-align:center;margin:6px 0 8px;text-transform:uppercase;font-weight:900;letter-spacing:.5px;color:#ffd9ff;
         text-shadow:0 0 12px #ff52e4,0 0 28px #7e61ff,0 0 60px #56d0ff}
  .brand .mega{font-size:clamp(16px,3.6vw,20px);display:block}
  .brand .title{font-size:clamp(28px,6.7vw,40px);display:block}

  .bezel{position:relative;border-radius:24px;padding:clamp(10px,2.4vw,14px);
         background:linear-gradient(180deg,var(--bezel1),var(--bezel2) 30%,var(--bezel3) 75%,var(--bezel4) 100%);
         box-shadow:inset 0 1px 0 rgba(255,255,255,.7), inset 0 -6px 0 rgba(0,0,0,.35); outline:2px solid rgba(255,255,255,.15)}
  .shine{position:absolute; inset:10px; border-radius:18px; pointer-events:none;
         background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,0) 32%); mix-blend-mode:screen}
  .window{position:relative;border-radius:18px;background:linear-gradient(180deg,var(--panel1),var(--panel2));
          outline:1px solid rgba(255,255,255,.15); padding:clamp(12px,2.6vw,16px) clamp(12px,2.8vw,18px);
          box-shadow: inset 0 0 30px rgba(0,0,0,.65), inset 0 22px 60px rgba(0,0,0,.55)}
  .glass{position:absolute; inset:0; pointer-events:none; border-radius:18px;
         background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,0) 35%),
                    radial-gradient(420px 180px at 50% -25%, rgba(255,255,255,.22), transparent 65%),
                    linear-gradient(to right, rgba(255,255,255,.06), rgba(255,255,255,0) 25%, rgba(255,255,255,.06) 75%, rgba(255,255,255,0) 100%);
         mix-blend-mode:screen}

  .reels{display:grid; grid-template-columns:repeat(3,1fr); gap:clamp(8px,2.2vw,14px); height:clamp(140px,30vw,200px); perspective:1200px}
  .reel{position:relative; border-radius:12px; overflow:hidden; background:#0b1230; outline:1px solid rgba(255,255,255,.12);
        box-shadow:inset 0 1px 0 rgba(255,255,255,.06), inset 0 -8px 0 rgba(0,0,0,.6)}
  .col{position:absolute; inset:-40px 0 -40px 0; display:flex; flex-direction:column; align-items:center; gap:18px; padding:14px 12px; transform-style:preserve-3d}
  .sym{width:100%; height:clamp(54px,11vw,72px); display:grid; place-items:center; font-size:clamp(28px,6vw,40px); font-weight:900; color:#fff;
       text-shadow:0 4px 14px rgba(0,0,0,.6); background:linear-gradient(180deg,#24307a,#191f56); border-radius:12px; outline:1px solid rgba(255,255,255,.12)}
  .col.spinblur .sym{filter:drop-shadow(0 8px 6px rgba(0,0,0,.35)) blur(.18px)}

  .panel{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap}
  .badge{padding:8px 12px; border-radius:12px; font-weight:800; background:linear-gradient(180deg,#141c3b,#0f1732); outline:1px solid rgba(255,255,255,.1)}
  .badge .v{color:#d8b6ff}
  .jackpot{flex:1 1 100%; text-align:center; margin-top:6px; font-weight:900; letter-spacing:2px; font-size:clamp(14px,3.2vw,20px); color:#ffe16a;
           text-shadow:0 0 12px #ff5fdb, 0 0 24px #7af0ff}
  .meters{display:flex; gap:12px; align-items:center}
  .ring{--p:0; width:clamp(38px,8vw,46px); height:clamp(38px,8vw,46px); border-radius:50%; background:conic-gradient(var(--accent) calc(var(--p)*1%), #222 0); display:grid; place-items:center; font-size:12px; font-weight:900; box-shadow:0 0 18px rgba(192,107,255,.35)}
  .ring span{background:#0a0d1a; color:#fff; width:clamp(26px,6vw,32px); height:clamp(26px,6vw,32px); display:grid; place-items:center; border-radius:50%}
  .jack{height:8px; width:clamp(120px,34vw,160px); border-radius:999px; background:#2a2a2a; position:relative; overflow:hidden; box-shadow:0 0 18px rgba(255,96,216,.25)}
  .jack:before{content:""; position:absolute; inset:0; background:linear-gradient(90deg,#ff62ff,#65f0ff); transform-origin:left; transform:scaleX(var(--fill,0)); transition:transform .25s ease}

  /* CONTROLS AREA */
  .controls{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px
  }
  .btn.primary{cursor:pointer; border:0; border-radius:16px; padding:clamp(12px,2.8vw,14px) clamp(16px,4.6vw,18px);
               font-weight:900; text-transform:uppercase; letter-spacing:.5px;
               background:radial-gradient(60% 100% at 50% 0%, #ff66c7, #6d2df7 70%); color:#fff;
               box-shadow:0 0 22px #b86cff, inset 0 -4px 0 rgba(0,0,0,.45)}
  .btn.primary:disabled{opacity:.55; pointer-events:none}

  .lever{position:relative; width:clamp(64px,12vw,76px); height:clamp(82px,16vw,96px); cursor:pointer; touch-action:manipulation}
  .lever .stem{position:absolute; left:calc(50% - 11px); bottom:8px; width:22px; height:calc(100% - 24px); border-radius:12px; background:linear-gradient(180deg,#cfcfcf,#7a7a7a); box-shadow:inset 0 2px 0 #fff}
  .lever .knob{position:absolute; left:50%; transform:translateX(-50%); top:-4px; width:clamp(44px,9vw,48px); height:clamp(44px,9vw,48px); border-radius:50%;
               background:radial-gradient(circle at 30% 30%, #fff, #ffe9ff 40%, #ff9af2 70%, #6a2dd1 100%); box-shadow:0 0 24px #b86cff; transform-origin:50% 80%; transition: transform .16s ease}
  .lever.pull .knob{transform: translateX(-50%) rotate(18deg) translateY(6px)}

  .payout{min-height:18px; font-size:clamp(12px,2.8vw,14px); color:var(--muted); margin-top:6px}

  .winflash{position:absolute; inset:0; border-radius:30px; pointer-events:none; opacity:0; transition:opacity .25s ease;
            background:radial-gradient(600px 260px at 50% -10%, rgba(255,255,255,.18), transparent 60%), radial-gradient(600px 260px at 50% 110%, rgba(255,235,140,.25), transparent 60%)}
  .cab.win .winflash{opacity:1}
  .cab.shake{animation:shake .28s ease}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}

  /* -------- Overlay (scrollable) -------- */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,12,.86);
    display:none; z-index:9999;
    padding:16px;
    backdrop-filter: blur(4px);
    align-items:center; justify-content:center;
    overflow:auto; overscroll-behavior:contain;
    -webkit-overflow-scrolling: touch;
  }
  .overlay.show{display:flex}

  .gifModal{
    --gifW: 220px; /* smaller gift GIF */
    width:min(560px,92vw);
    border-radius:22px;
    background:radial-gradient(120% 120% at 50% 0%, #1a1740 0%, #0d1230 60%);
    outline:1px solid rgba(180,220,255,.25);
    box-shadow:0 24px 90px rgba(0,0,0,.75);
    transform:scale(.96); animation:popIn .28s ease forwards;
    max-height:92svh;
    display:flex; flex-direction:column;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
  }
  @keyframes popIn{to{transform:scale(1)}}
  .grabber{ width:48px; height:5px; border-radius:999px; margin:8px auto 10px; background:rgba(255,255,255,.25); }
  .modalBody{display:flex; flex-direction:column; gap:12px; padding:18px}
  .mediaBox{ display:flex; flex-direction:column; gap:10px; align-items:center; }
  .giftGif{
    width:100%; max-width:var(--gifW); height:auto; display:block; margin:0 auto;
    border-radius:14px; outline:1px solid rgba(255,255,255,.12);
    box-shadow:0 10px 40px rgba(120,80,255,.35);
  }
  .videoWrap{
    width:100%; max-width:520px;
    position:relative; padding-top:56.25%;
    border-radius:14px; overflow:hidden; outline:1px solid rgba(255,255,255,.12);
    box-shadow:0 10px 40px rgba(120,80,255,.20);
    margin-top:12px;
    background:#000;
  }
  .videoWrap iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }

  .voucher{
    font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
    font-size:clamp(14px,3.6vw,18px);
    letter-spacing:.6px; padding:12px 14px; border-radius:12px;
    color:#d8b6ff; background:#0a0d1a; display:inline-block;
    outline:1px dashed rgba(160,220,255,.4);
  }
  .row{display:flex; gap:10px; justify-content:center; margin-top:4px; flex-wrap:wrap}
  .copy,.close{
    cursor:pointer; border:0; border-radius:12px; padding:10px 14px;
    font-weight:900; font-size:clamp(13px,3.6vw,14px)
  }
  .copy{background:#2b2b2b; color:#fff} .close{background:#fff; color:#111}

  #fx{position:absolute; inset:0; pointer-events:none}

  /* Sound toggle */
  .bgmBtn{
    position:fixed; top:10px; right:10px; z-index:99999;
    border:1px solid rgba(255,255,255,.2);
    background:rgba(6,9,18,.6); backdrop-filter:blur(6px);
    color:#eaf2ff; font-weight:700; font-size:12px; border-radius:999px; padding:6px 10px;
    box-shadow:0 4px 10px rgba(0,0,0,.35);
  }
  .bgmBtn[aria-pressed="false"]{ opacity:.65 }
</style>
</head>
<body>

<a class="backBtn" id="backBtn" href="index.html" aria-label="Volver al menÃº">
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 6l-6 6 6 6" stroke="#0c1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  Volver
</a>

<div class="cabWrap">
  <div class="cab" id="cab">
    <canvas id="fx"></canvas>
    <div class="tubes"></div>

    <div class="marquee" aria-hidden="true">
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
    </div>

    <div class="brand"><span class="mega">RicoBet</span><span class="title">SLOTS</span></div>

    <div class="bezel">
      <div class="shine"></div>
      <div class="window">
        <div class="reels" id="reels"></div>
        <div class="glass"></div>
      </div>
    </div>

    <div class="panel">
      <div class="badge">Tiros restantes: <span class="v" id="spinsLeft">5</span></div>
      <div class="meters">
        <div class="ring" id="ring"><span id="ringNum">0</span></div>
        <div class="jack" id="jack"></div>
      </div>
      <div class="jackpot">JACKPOT</div>
    </div>

    <div class="controls">
      <!-- IMPORTANTE: dos clases "btn" y "primary" (no "btn.primary") -->
      <button class="btn primary" id="spin">Girar</button>
      <div class="lever" id="lever" role="button" aria-label="Tira de la palanca para girar" tabindex="0">
        <div class="stem"></div><div class="knob"></div>
      </div>
    </div>
    <div class="payout" id="payout"></div>

    <div class="winflash"></div>
  </div>

  <div class="groundShadow"></div>
</div>

<!-- Ventana de cupÃ³n -->
<div class="overlay" id="giftOverlay" role="dialog" aria-modal="true">
  <div class="gifModal" role="document">
    <div class="grabber" aria-hidden="true"></div>
    <div class="modalBody">
      <div class="mediaBox">
        <img class="giftGif"
             id="giftGif"
             src="https://ricomx.ft-crm.com/media-api/serve/64ae8b79-831d-4b08-80e9-6fbbc37e2e80_Surprise_GIF"
             alt="AnimaciÃ³n de regalo sorpresa"
             decoding="async" loading="eager" referrerpolicy="no-referrer" draggable="false" />
      </div>

      <div class="voucher" id="voucherText">VOUCHER-XXXX</div>
      <div class="row">
        <button class="copy" id="copyBtn">Copiar cÃ³digo</button>
        <button class="close" id="closeBtn">Cerrar</button>
      </div>

      <div style="text-align:center;color:#a9b7d8;font-weight:700;margin-top:8px;">
        Mira cÃ³mo canjearloâ€¦
      </div>

      <div class="videoWrap" id="howtoVideo">
        <iframe
          src="https://www.youtube.com/embed/w7gg1UKQ71g?rel=0&modestbranding=1&playsinline=1"
          title="CÃ³mo canjear tu cupÃ³n"
          allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
      </div>

      <div class="small" style="color:#a9b7d8;margin-top:4px; text-align:center">Canjea este cÃ³digo en tu cuenta.</div>
    </div>
  </div>
</div>

<!-- Efectos de sonido -->
<audio id="sSpin"  src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/lever.mp3" preload="auto"></audio>
<audio id="sStop"  src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/stop.mp3"  preload="auto"></audio>
<audio id="sWin"   src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"   preload="auto"></audio>
<audio id="sLever" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/lever.mp3" preload="auto"></audio>

<!-- BGM de fondo (bajo) -->
<audio id="bgm" src="theme.mp3" preload="auto" loop playsinline></audio>
<button id="bgmToggle" class="bgmBtn" aria-pressed="false" hidden>ðŸ”Š Sonido</button>

<script>
const MAX_SPINS=5;
const SYMBOLS=["ðŸ’","ðŸŠ","ðŸ‹","ðŸ’Ž","â­","7ï¸âƒ£","BAR"];
/* === CÃ³digos de cupÃ³n de Slots (solo esto cambia) === */
const CODES   =["VIPS05","VIPS25"];
const STATE_KEY='slot_purple_state_fx1';
const VOUCHER_KEY='slot_purple_voucher_fx1';

let state=loadState();
let spinning=false, started=false, turbo=false;

const reelsEl=document.getElementById('reels');
const spinBtn=document.getElementById('spin');
const lever=document.getElementById('lever');
const cab=document.getElementById('cab');
const payoutEl=document.getElementById('payout');
const spinsLeftEl=document.getElementById('spinsLeft');
const ring=document.getElementById('ring'); const ringNum=document.getElementById('ringNum');
const jack=document.getElementById('jack');
const sSpin=document.getElementById('sSpin'); const sStop=document.getElementById('sStop'); const sWin=document.getElementById('sWin');
const sLever=document.getElementById('sLever');

const giftOverlay = document.getElementById('giftOverlay');
const voucherText = document.getElementById('voucherText');
const copyBtn     = document.getElementById('copyBtn');
const closeBtn    = document.getElementById('closeBtn');
const backBtn     = document.getElementById('backBtn');
const giftGif     = document.getElementById('giftGif');

/* ====== BGM / Sonido ====== */
const bgm = document.getElementById('bgm');
const bgmBtn = document.getElementById('bgmToggle');
const BGM_BASE = 0.25;
const BGM_DUCK = 0.06;
let duckTimer = null;

function showBgmBtn(){ bgmBtn.hidden = false; }
function setBgmUI(on){ bgmBtn.setAttribute('aria-pressed', on ? 'true' : 'false'); }
function setBgmLabel(on){ bgmBtn.textContent = on ? "ðŸ”Š Sonido" : "ðŸ”‡ Sonido"; }
function duck(ms=1400){
  clearTimeout(duckTimer);
  bgm.volume = BGM_DUCK;
  duckTimer = setTimeout(()=>{ if(!bgm.paused) bgm.volume = BGM_BASE; duckTimer=null; }, ms);
}

// Calentamiento (mudo) para permitir autoplay
window.addEventListener('load', async ()=>{
  try{ bgm.volume=BGM_BASE; bgm.muted=true; await bgm.play(); }catch(e){}
  showBgmBtn(); setBgmUI(!bgm.paused); setBgmLabel(!bgm.paused);
}, {once:true});

// Desmutear en la primera interacciÃ³n en cualquier parte
['pointerdown','touchstart','mousedown','keydown'].forEach(ev=>{
  window.addEventListener(ev, async function firstInteract(){
    try{ if(bgm.paused){ await bgm.play(); } bgm.muted=false; bgm.volume=BGM_BASE; setBgmUI(true); setBgmLabel(true); }catch(e){}
    window.removeEventListener(ev, firstInteract, {capture:false});
  }, {once:true, passive:true});
});

// Conmutador manual (opcional)
bgmBtn.addEventListener('click', async ()=>{
  try{
    if(bgm.paused){ bgm.muted=false; bgm.volume=BGM_BASE; await bgm.play(); setBgmUI(true); setBgmLabel(true); }
    else{ bgm.pause(); setBgmUI(false); setBgmLabel(false); }
  }catch(e){}
});

/* ====== UI ====== */
spinsLeftEl.textContent=state.left; updateMeters();
if(state.claimed){ openGift(localStorage.getItem(VOUCHER_KEY)||'CANJEADO'); disableControls(); }

/* Construir rodillos */
function makeReel(){
  const reel=document.createElement('div'); reel.className='reel';
  const col=document.createElement('div'); col.className='col';
  const pool=[]; for(let i=0;i<20;i++){ pool.push(SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]) }
  pool.forEach(s=>{ const it=document.createElement('div'); it.className='sym'; it.textContent=s; col.appendChild(it) });
  reel.appendChild(col); return reel;
}
for(let i=0;i<3;i++){ reelsEl.appendChild(makeReel()); }

/* ðŸŸ£ FIX: pre-llenar los sÃ­mbolos visibles antes del primer giro */
document.querySelectorAll('.reel .col').forEach(col=>{
  const visible = Array.from(col.children).slice(8, 11); // aprox. los 3 del medio
  visible.forEach(it=>{
    it.textContent = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
  });
});

/* Flujo de giro */
function spin(){
  if(spinning || state.claimed) return;
  if(!started){ started=true; if(backBtn) backBtn.style.display='none'; }
  if(state.left<=0){ maybeVoucher(); return; }

  spinning=true; payoutEl.textContent=''; lever.classList.add('pull');

  // Sonido de palanca inmediato
  try{ sLever.currentTime=0; sLever.play(); }catch(e){}
  duck(500);

  // Sonido de inicio
  sSpin && sSpin.play().catch(()=>{});

  const cols=[...document.querySelectorAll('.reel .col')];
  const targets = cols.map(() => SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]);
  const results=[];

  cols.forEach((col,idx)=>{
    const dur=(turbo? 600: 1450)+idx*220;
    const t0=performance.now(); col.classList.add('spinblur');

    (function anim(){
      const t=performance.now()-t0, p=Math.min(1,t/dur), e=1-Math.pow(1-p,3);
      const itemH=parseFloat(getComputedStyle(document.documentElement).fontSize)*4.5;
      const offset=-(e*16*itemH);
      col.style.transform=`translateY(${offset}px) rotateX(${e*18}deg)`;

      if(t<dur){ requestAnimationFrame(anim); }
      else{
        const last = col.lastElementChild;
        if(last){ last.textContent = targets[idx]; }
        col.style.transform='translateY(0)'; col.classList.remove('spinblur');
        while(col.children.length>20){ col.removeChild(col.firstChild) }
        results[idx]=targets[idx];
        if(results.filter(Boolean).length===cols.length){
          lever.classList.remove('pull');
          sStop && sStop.play().catch(()=>{});
          onStop(results);
        }
      }
    })();
  });
}

function onStop(arr){
  state.spun=(state.spun||0)+1;

  const freq={}; arr.forEach(s=>freq[s]=(freq[s]||0)+1);
  let best=0; for(const k in freq){ if(freq[k]>best) best=freq[k] }
  if(best>=3){
    state.wins=(state.wins||0)+1; state.hit3=true;
    payoutEl.innerHTML='<span style="color:var(--green);font-weight:900">Â¡PREMIO!</span>';
    duck(1800);
    sWin && sWin.play().catch(()=>{});
    coinBurst(); shake();
    cab.classList.add('win'); setTimeout(()=>cab.classList.remove('win'),700);
  } else {
    payoutEl.textContent='Vuelve a girar';
  }

  state.left=Math.max(0,state.left-1); saveState(state);
  spinsLeftEl.textContent=state.left; updateMeters();
  maybeVoucher();
}

function updateMeters(){
  const used=MAX_SPINS-state.left;
  ring.style.setProperty('--p', Math.round((used/MAX_SPINS)*100));
  ringNum.textContent=used;
  jack.style.setProperty('--fill', Math.min(1,(state.wins||0)/3));
}

function maybeVoucher(){
  if(state.claimed){ spinning=false; return; }
  const reveal=(state.left===0)||(Math.random()<0.32);
  if(reveal){
    const code=CODES[Math.floor(Math.random()*CODES.length)];
    localStorage.setItem(VOUCHER_KEY, code);
    state.claimed=true; saveState(state);
    openGift(code); disableControls();
  }
  spinning=false;
}

function openGift(code){
  voucherText.textContent = code;
  giftOverlay.classList.add('show');
  confetti();
}
copyBtn.addEventListener('click',()=> copyText(voucherText.textContent.trim()));
closeBtn.addEventListener('click',()=> giftOverlay.classList.remove('show'));

giftOverlay.addEventListener('click', (e)=>{
  const md = document.querySelector('.gifModal');
  if(!md) return;
  if(!md.contains(e.target)) giftOverlay.classList.remove('show');
});

function disableControls(){ spinBtn.disabled=true; lever.style.pointerEvents='none' }
spinBtn.addEventListener('click',spin);
lever.addEventListener('click',spin);
lever.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); spin(); }});
spinBtn.addEventListener('mousedown',()=>{ turbo=true; lever.classList.add('pull') });
spinBtn.addEventListener('mouseup',()=>{ turbo=false; lever.classList.remove('pull') });
spinBtn.addEventListener('mouseleave',()=>{ turbo=false; lever.classList.remove('pull') });

// Extra: sfx de palanca al presionar
lever.addEventListener('pointerdown',()=>{ try{ sLever.currentTime=0; sLever.play(); }catch(e){} }, {passive:true});
spinBtn.addEventListener('pointerdown',()=>{ try{ sLever.currentTime=0; sLever.play(); }catch(e){} }, {passive:true});

/* Copiar al portapapeles */
async function copyText(txt){
  if(!txt) return;
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(txt);
      copiedUI();
      return;
    }
  }catch(_){}
  const ta=document.createElement('textarea');
  ta.value=txt; ta.setAttribute('readonly','');
  ta.style.position='fixed'; ta.style.top='-9999px'; ta.style.opacity='0';
  document.body.appendChild(ta);
  ta.select(); ta.setSelectionRange(0, ta.value.length);
  try{ document.execCommand('copy'); }catch(_){}
  document.body.removeChild(ta);
  copiedUI();
}
function copiedUI(){
  copyBtn.textContent='Â¡Copiado!';
  setTimeout(()=>copyBtn.textContent='Copiar cÃ³digo',1200);
}

/* iOS GIF fallback */
(function ensureGifShows(){
  const url=giftGif.getAttribute('src')||'';
  let tried=false;
  function tryFix(){
    if(tried) return; tried=true;
    if(!/\.gif(\?|$)/i.test(url)){ giftGif.src = url + '.gif'; }
  }
  giftGif.addEventListener('error', tryFix, { once:true });
  setTimeout(()=>{ if(giftGif.naturalWidth===0 || giftGif.naturalHeight===0){ tryFix(); } }, 900);
})();

function loadState(){ try{ return JSON.parse(localStorage.getItem(STATE_KEY)) || {left:MAX_SPINS,claimed:false,spun:0,wins:0,hit3:false} } catch{ return {left:MAX_SPINS,claimed:false,spun:0,wins:0,hit3:false} } }
function saveState(s){ localStorage.setItem(STATE_KEY, JSON.stringify(s)) }

/* Lienzo FX */
const fx=document.getElementById('fx'); const ctx=fx.getContext('2d');
function resize(){ fx.width=cab.clientWidth; fx.height=cab.clientHeight }
addEventListener('resize',resize);
addEventListener('orientationchange',()=>setTimeout(resize,250));
resize();

function coinBurst(){
  const parts=[]; for(let i=0;i<90;i++) parts.push({x:fx.width/2, y:fx.height/2+40, vx:(Math.random()-0.5)*4, vy:-Math.random()*3-2, r:Math.random()*3+2, g:0.06+Math.random()*0.02, life:120+Math.random()*40});
  let t=0; (function loop(){ t++; ctx.clearRect(0,0,fx.width,fx.height); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.life--; ctx.globalAlpha=Math.max(0,p.life/160); ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle='gold'; ctx.fill();}); ctx.globalAlpha=1; if(t<170) requestAnimationFrame(loop); })();
}
function confetti(){
  const p=[]; for(let i=0;i<180;i++) p.push({x:fx.width/2,y:fx.height/2-80,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6-2,life:140+Math.random()*50,r:2+Math.random()*3,h:Math.random()*360});
  (function loop(){ ctx.clearRect(0,0,fx.width,fx.height); p.forEach(o=>{ o.x+=o.vx; o.y+=o.vy; o.vy+=0.05; o.life--; ctx.globalAlpha=Math.max(0,o.life/180); ctx.fillStyle=`hsl(${o.h},100%,60%)`; ctx.fillRect(o.x,o.y,o.r,o.r);}); ctx.globalAlpha=1; if(p.some(o=>o.life>0)) requestAnimationFrame(loop); })();
}
function shake(){ cab.classList.add('shake'); setTimeout(()=>cab.classList.remove('shake'),300) }
</script>
</body>
</html>
